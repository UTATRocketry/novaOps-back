<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket JSON Viewer</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        pre { background: #f4f4f4; border: 1px solid #ddd; padding: 10px; overflow-x: auto; }
        #status { color: green; }
        #reconnect-status { color: orange; font-style: italic; }
        #json-data-button { 
            margin-top: 10px; 
            padding: 8px 12px; 
            font-size: 16px; 
            cursor: pointer; 
            background-color: rgb(207, 207, 207);
            border: #2d2c2c solid 1px;
            border-radius: 3px;
        }
        #json-data-button:hover { 
            background-color: gray; }
    </style>
</head>
<body>
    <p>Status: <span id="status">Connecting...</span></p>
    <p id="reconnect-status"></p>
    <button id="json-data-button" onclick="toggleData()">Get MQTT Data</button>
    <pre id="json-data">Waiting for data...</pre>
    <script>
        let isMqttData = false;
        let wsEndpoint = isMqttData ? "ws_raw_data": "ws_basic";
        let wsUrl = `ws://192.168.0.1:8000/${wsEndpoint}`;

        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        const reconnectInterval = 2000; // 2 seconds

        const statusElem = document.getElementById("status");
        const dataElem = document.getElementById("json-data");
        const reconnectStatusElem = document.getElementById("reconnect-status");
        
        

        function toggleData() {
            const btn = document.getElementById("json-data-button");
            isMqttData = !isMqttData;
            btn.textContent = isMqttData ? "Get Backend Data" : "Get MQTT Data";
            wsEndpoint = isMqttData ? "ws_raw_data": "ws_basic";
            wsUrl = `ws://192.168.0.1:8000/${wsEndpoint}`;
        }

        function connectWebSocket() {
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                statusElem.textContent = "Connected";
                statusElem.style.color = "green";
                reconnectStatusElem.textContent = "";
                reconnectAttempts = 0;
            };

            socket.onmessage = (event) => {
                try {
                    const jsonData = JSON.parse(event.data);
                    dataElem.textContent = JSON.stringify(jsonData, null, 4);
                } catch (err) {
                    console.error("Error parsing JSON:", err);
                    dataElem.textContent = "Invalid JSON received.";
                }
            };

            socket.onerror = (error) => {
                statusElem.textContent = "Error";
                statusElem.style.color = "red";
                console.error("WebSocket error:", error);
            };

            socket.onclose = () => {
                statusElem.textContent = "Disconnected";
                statusElem.style.color = "orange";
                attemptReconnect();
            };
        }

        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                reconnectStatusElem.textContent = `Reconnecting... (Attempt ${reconnectAttempts} of ${maxReconnectAttempts})`;
                setTimeout(() => {
                    connectWebSocket();
                }, reconnectInterval);
            } else {
                reconnectStatusElem.textContent = "Failed to reconnect after multiple attempts.";
                reconnectStatusElem.style.color = "red";
            }
        }
        // Start WebSocket connection
        connectWebSocket();
    </script>
</body>
</html>