<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actuator Commands Viewer</title>
    <style>
        th { text-align: center; }
        th { background-color: #f2f2f2; }
        #status { color: lightgrey; }
        #status { color: gray; }
        #status { color: lightgreen; }
    </style>
</head>
<body>
    <button id="lock-button" onclick="toggleActuatorsLock()">Lock Actuators</button>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>State</th>
            </tr>
        </thead>
        <tbody id="actuators-table">
            <!-- Actuators will be dynamically loaded here -->
        </tbody>
    </table>

    <script>
        let isLocked = false; // Global variable to track lock state
        async function toggleActuatorsLock(actuator) {
            isLocked = !isLocked; // Toggle lock state
            const lockButton = document.getElementById('lock-button');
            lockButton.textContent = isLocked ? 'Unlock Actuators' : 'Lock Actuators';
        }
        async function fetchActuators() {
            try {
                const response = await fetch('http://192.168.0.1:8000/get_actuators', {
                    headers: { 'Accept': 'application/json' }
                });
                const actuators = await response.json();
                const tableBody = document.getElementById('actuators-table');
                tableBody.innerHTML = '';

                actuators.forEach(actuator => {
                    actuator.state = actuator.state || "closed"; // Default state for demonstration
                    actuator.status = actuator.status || 'off'; // Ensure status is defined
                    const row = document.createElement('tr');

                    const nameCell = document.createElement('td');
                    nameCell.textContent = actuator.name;
                    row.appendChild(nameCell);

                    const stateCell = document.createElement('td');
                    const stateButton = document.createElement('button');
                    stateButton.style.backgroundColor = actuator.state === 'open' ? 'green' : 'red';
                    stateButton.textContent = actuator.state === 'open' ? 'open' : 'closed';
                    stateButton.onclick = async () => {
                        if (isLocked) {
                            alert('Actuators are locked. Please unlock to change states.');
                        }
                        else if (actuator.type === 'servo' && actuator.status === 'off') {
                            alert('Servo is disabled. Please enable it first.');
                        }
                        else {
                            const newState = actuator.state === 'open' ? 'closed' : 'open';
                            // sendCommand(actuator.name, actuator.type, newState);
                            try {
                                await fetch('http://192.168.0.1:8000/send_command', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ type: actuator.type, name: actuator.name, state: newState })
                                });
                                // fetchActuators(); // Refresh the table after sending the command
                            } catch (error) {
                                console.error('Error sending command:', error);
                            }
                            actuator.state = newState; // Update the state locally
                            stateButton.style.backgroundColor = newState === 'open' ? 'green' : 'red';
                            stateButton.textContent = newState === 'open' ? 'open' : 'closed';
                        }
                    };
                    stateCell.appendChild(stateButton);

                    if (actuator.type === 'servo') {
                        const statusButton = document.createElement('button');
                        statusButton.style.backgroundColor = actuator.status === 'on' ? 'lightgrey' : 'gray';
                        statusButton.textContent = actuator.status === 'on' ? 'enabled' : 'disabled';
                        statusButton.onclick = async () => {
                            if (isLocked) {
                                alert('Actuators are locked. Please unlock to change states.');
                            }
                            else {
                                const newStatus = actuator.status === 'on' ? 'off' : 'on';
                                // sendCommand(actuator.name, actuator.type, newState);
                                try {
                                    await fetch('http://192.168.0.1:8000/send_command', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ type: actuator.type, name: actuator.name, state: newStatus })
                                    });
                                    // fetchActuators(); // Refresh the table after sending the command
                                } catch (error) {
                                    console.error('Error sending command:', error);
                                }
                                actuator.status = newStatus; // Update the state locally
                                statusButton.style.backgroundColor = actuator.status === 'on' ? 'lightgrey' : 'gray';
                                statusButton.textContent = actuator.status === 'on' ? 'enabled' : 'disabled';
                            }
                        };
                        stateCell.appendChild(statusButton);
                    }
                    row.appendChild(stateCell);

                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching actuators:', error);
            }
        }

        async function sendCommand(name, type, state) {
            try {
                await fetch('http://192.168.0.1:8000/send_command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, name, state })
                });
                // fetchActuators(); // Refresh the table after sending the command
            } catch (error) {
                console.error('Error sending command:', error);
            }
        }

        async function reload() {
            try {
                // await fetch('http://192.168.0.1:8000/close_all');
                fetchActuators();
            }
            catch (error) {
                console.error('Error reloading actuators:', error);
            }

        }
        // Load actuators on page load
        window.onload = reload;
    </script>
</body>
</html>